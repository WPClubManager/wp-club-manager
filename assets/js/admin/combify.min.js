!function(a){a.widget("ui.combify",{options:{maxLength:0},_create:function(){function b(b,c,d){function e(a){function b(b){a.preventDefault();var e=f.find(":selected");if(b===c)var g=e.next();if(b===d)var g=e.prev();e.prop("selected",!1),g.prop("selected","selected")}var c="down",d="up";return 38===a.which&&f.is(":visible")?void b(d):40===a.which&&f.is(":visible")?void b(c):13===a.which&&f.is(":visible")?(f.trigger("change"),void f.hide()):void(f.is(":visible")&&f.hide())}var f=b.parent().parent().next();if(f.is(":visible")||a(i).autocomplete("widget").is(":visible"))f.hide();else{var g;g=n.length<=30?n.length:30;var h=1===g?2:g;f.css({width:"auto",position:"absolute","z-index":"1"}).prop("size",h).show(),d>f.width()&&f.css("width",d);var j=parseInt(f.find("option").first().css("font-size"),10);f.css("height",j*(g+1)),a(document).one("click",function(){f.hide()}),a(document).off("keydown.combifySelect").on("keydown.combifySelect",e)}}var c=this,d=c.element,e=c.options,f=d.prop("id"),g="#"+f,h="CombifyInput-"+f,i="#"+h,j=d.prop("name"),k=d.find(":selected").val(),l=d.find(":selected").text(),m=d.find("option"),n=new Array;d.hide(),d.before('<div><span class="ui-combobox"><input type="hidden" class="insertedInput" id="'+f+'" name="'+j+'" value="'+k+'"><input type="text" id="'+h+'" class="ui-combobox-input" value="'+l+'"></span></div>'),d.removeAttr("id",null).removeAttr("name",null).on("change",function(a){a.stopPropagation()}),m.each(function(b){n.push(a(this).text())}),a(i).autocomplete({source:n,select:function(b,c){this.value=c.item.value;var e=a(d).find("option").filter(function(){return a(this).html()==c.item.value}).first(),f=e.val();a(g).val(f),a(this).trigger("change")}}).on("change",function(){var b=a(this).val(),c=a(d).find("option").filter(function(){return a(this).html()==b}).first();c.length?a(g).val(c.val()):a(g).val(b)}).on("blur",function(){a(this).trigger("change")}),e.maxLength>0&&a(i).keyup(function(){if(a(this).val().length>e.maxLength){var b=a(this).val();a(this).data("val",b.substring(0,e.maxLength)),a(this).val(b.substring(0,e.maxLength))}}),d.on("change",function(){var b=a(this).prev().find("#"+f).first(),c=a(this).val(),e=a(this).find("option:selected").text(),g=a(d).find("option").filter(function(){return a(this).html()==e}).first();b.val(c),a(i).val(g.text()),b.trigger("change")}),a(i).keydown(function(c){var d=a(this).parent().parent().next();40===c.which&&c.altKey&&(c.preventDefault(),c.stopPropagation(),d.is(":visible")?d.hide():(e.capitalizeInput&&(this.value=this.value.toUpperCase()),a(i).autocomplete("close"),b(a(this),c,a(this).width())))}),d.prev().first().find(".ui-combobox-list").change(function(){a(this).hide()})},_destroy:function(){var a=this.element,b=a.prev().find(".insertedInput"),c="",d="";c=b.prop("id"),d=b.prop("name"),a.attr({id:c,name:d}),a.off("change"),a.prev().remove(),a.show()}})}(jQuery);